# Suite runners prefrom build -> install -> test
# see also compose-suite.yml
#
#   - Build is not run if BUILDHOST is an empty string.
#   - Integration tests are not run if BUILDLIST differs from ST2_PACKAGES (all available packages).
#   - Integration tests can be DISABLED if you set TESTHOSTS to an empty string.
#

# wheezy (previous), light one, number one to be containerized.
debian:
  image: quay.io/stackstorm/packagingrunner
  extends:
    file: compose-suite.yml
    service: suite
  environment:
    - BUILDNODE=bwheezy
  links:
    - bwheezy
    # - iwheezy
    # - rabbitmq
    # - mongodb
    # - postgres

# 14.04
ubuntu:
  image: quay.io/stackstorm/packagingrunner
  extends:
    file: compose-suite.yml
    service: suite
  environment:
    - BUILDNODE=btrusty
  links:
    - btrusty
    # - itrusty
    # - rabbitmq
    # - mongodb
    # - postgres

centos7:
  image: quay.io/stackstorm/packagingrunner
  extends:
    file: compose-suite.yml
    service: suite
  environment:
    - BUILDNODE=bcentos7
  links:
    - bcentos7
    # - icentos7
    # - rabbitmq
    # - mongodb
    # - postgres

centos6:
  image: quay.io/stackstorm/packagingrunner
  extends:
    file: compose-suite.yml
    service: suite
  environment:
    - ST2_PYTHON=1
    - BUILDNODE=bcentos6
  links:
    - bcentos6
    # - icentos6
    # - rabbitmq
    # - mongodb
    # - postgres

# -----------------------------------------------------------------------------

# External Services
#
rabbitmq:
  image: rabbitmq:management
  hostname: rabbit
  ports:
    - "15672:15672"  # managment plugin port
    - "5672:5672"

mongodb:
  image: mongo
  ports:
    - "27017:27017"

postgres:
  image: postgres
  ports:
    - "5432:5432"
  environment:
    - POSTGRES_USER=mistral
    - POSTGRES_PASSWORD=StackStorm

# Build Instances
#
bwheezy:
  image: quay.io/stackstorm/packagingenv:wheezy
  volumes:
    - /tmp/st2-packages:/root/build

btrusty:
  image: quay.io/stackstorm/packagingenv:trusty
  volumes:
    - /tmp/st2-packages:/root/build

bcentos6:
  image: quay.io/stackstorm/packagingenv:centos6
  volumes:
    - /tmp/st2-packages:/root/build

bcentos7:
  image: quay.io/stackstorm/packagingenv:centos7
  volumes:
    - /tmp/st2-packages:/root/build


# Test Instances
#
itrusty:
  image: quay.io/dennybaa/droneunit:trusty-upstart
  volumes:
    - /tmp/st2-packages:/root/build

iwheezy:
  image: quay.io/dennybaa/droneunit:wheezy
  command: /usr/sbin/sshd -D
  volumes:
    - /tmp/st2-packages:/root/build

icentos6:
  image: quay.io/dennybaa/droneunit:centos6
  command: /usr/sbin/sshd -D
  volumes:
    - /tmp/st2-packages:/root/build

icentos7:
  image: quay.io/dennybaa/droneunit:centos7-systemd
  volumes:
    - /sys/fs/cgroup:/sys/fs/cgroup
    - /tmp/st2-packages:/root/build
