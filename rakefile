require 'rake'
require './rake/pipeline'

task :default => 'packages:build'

# Packages namespace build related tasks
namespace :packages do

  # CI pipeline helper and parallel output dispatcher
  ci = PipeLine.new
  ShellOut.run

  desc "Main entry packages build task"
  task :build => [:upload, :packages] do
    ShellOut.finalize
  end

  desc "Various uploads to the remotes"
  multitask :upload => [:upload_scripts, :upload_sources]
  task :upload_scripts do
    ci.exec.ssh hostname: ci.env.buildnode do
      upload! 'scripts', './', recursive: true
    end
  end

  task :upload_sources do
    ci.exec.ssh hostname: ci.env.buildnode do
      upload! 'packages', './', recursive: true
    end
  end

  multitask :packages => [
    :st2python
  ]
  desc "Build python task"
  task :st2python do
    ci.exec.ssh hostname: ci.env.buildnode do
      options label: 'package: st2python', show_uuid: false
      execute :mkdir, "-p #{ci.env.artifact_dir}"


      with(ci.env_select  :st2_python,
                            :st2_python_version,
                            :st2_python_release) do

                
        execute :bash, '/root/scripts/build_python.sh ./packages/python'
      end
    end
  end

  # hhhhhh

end
